<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Til√°pia IA ‚Äî Evite An√∫ncios Errados</title>

<style>
:root{
  --bg:#020617;
  --primary:#6366f1;
  --accent:#a855f7;
  --danger:#f97316;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#020617,#000);
  font-family:system-ui;
  color:#e5e7eb;
  display:flex;
  align-items:center;
  justify-content:center;
}
.container{
  width:100%;
  max-width:560px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:22px;
  padding:28px;
}
h1{text-align:center;margin:0 0 6px}
.sub{
  text-align:center;
  font-size:13px;
  color:#94a3b8;
  margin-bottom:22px;
}
input,button{
  width:100%;
  padding:16px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#fff;
  font-size:15px;
}
button{
  margin-top:14px;
  border:none;
  font-weight:800;
  cursor:pointer;
  background:linear-gradient(135deg,var(--primary),var(--accent));
}
.section{margin-top:26px;display:none}
.label{
  font-size:12px;
  text-transform:uppercase;
  font-weight:800;
  margin-bottom:6px;
}
.box{
  background:#020617;
  border:1px solid #1e293b;
  border-left:5px solid var(--primary);
  border-radius:14px;
  padding:16px;
  margin-bottom:14px;
  white-space:pre-wrap;
}
.risk{border-left-color:var(--danger)}
.blur{filter:blur(6px);opacity:.5}

.login-cta{
  display:none;
  margin-top:16px;
}
.login-cta button{
  background:transparent;
  border:1px dashed #6366f1;
  font-weight:800;
}

.paywall{
  display:none;
  margin-top:18px;
  background:linear-gradient(135deg,#4f46e5,#7c3aed);
  padding:18px;
  border-radius:14px;
  text-align:center;
}
.paywall p{
  font-size:14px;
  margin:0 0 12px;
}
.paywall button{
  background:#fff;
  color:#000;
  font-weight:900;
}

.footer{
  font-size:11px;
  color:#94a3b8;
  text-align:right;
}
</style>
</head>

<body>
<div class="container">
  <h1>Hucks IA</h1>
  <div class="sub">
    90% das pessoas erram isso em an√∫ncios.<br>
    Descubra antes de perder dinheiro.
  </div>

  <input id="produto" placeholder="Ex: Bolo de pote, Curso de ingl√™s, Manicure em domic√≠lio"/>
  <button id="gerar">üß† Gerar diagn√≥stico (1 tentativa gr√°tis)</button>

  <div id="resultado" class="section">

    <div class="label">‚ö†Ô∏è Seu risco agora</div>
    <div id="diagnostico" class="box risk"></div>

    <div class="label">üí∏ Impacto real</div>
    <div id="impacto" class="box"></div>

    <div class="label">üë• P√∫blico-alvo espec√≠fico</div>
    <div id="publico" class="box blur"></div>

    <div class="label">üò¢ √Çngulo emocional</div>
    <div id="angulo" class="box blur"></div>

    <div class="label">üñºÔ∏è Imagem ideal (descri√ß√£o)</div>
    <div id="imagem" class="box blur"></div>

    <div class="label">‚úçÔ∏è Texto de an√∫ncio (pessoa ‚Üí pessoa)</div>
    <div id="copy" class="box blur"></div>

    <div class="label">üìû CTAs variados pro funil</div>
    <div id="ctas" class="box blur"></div>

    <!-- LOGIN CTA -->
    <div class="login-cta" id="loginCtaWrapper">
      <button id="loginCta">
        üîê Entre para continuar evitando erros
                (recarregue ao logar)
      </button>
    </div>

    <!-- PAYWALL -->
    <div class="paywall" id="paywall">
      <p>
        Cada cr√©dito √© <b>uma tentativa de n√£o perder dinheiro</b>.<br><br>
        Continue com clareza total e redu√ß√£o de erros caros.
      </p>
      <button id="comprar">
        üí≥ Pacote com 10 cr√©ditos apenas R$7,99
      </button>
    </div>

    <div class="footer">
      Saldo: <b><span id="creditos">1</span></b> cr√©dito
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const API = location.hostname.includes("localhost")
  ? "http://localhost:3001"
  : "https://therux-backend.onrender.com";

let auth;
let token = null;
let creditos = 1;      // Valor inicial presumido para n√£o-logados
let gerou = false;

async function start() {
  const res = await fetch(`${API}/api/config`);
  const config = await res.json();
  auth = getAuth(initializeApp(config));

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      token = await user.getIdToken();
      const resCred = await fetch(`${API}/api/creditos`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await resCred.json();
      creditos = data.creditos;
      document.getElementById("creditos").innerText = creditos;
    } else {
      creditos = 1;
      document.getElementById("creditos").innerText = "1 (gr√°tis)";
    }
    updateUI();
  });
}
start();

function updateUI() {
  const logged = !!auth.currentUser;

  document.getElementById("creditos").innerText = logged ? creditos : "1 (gr√°tis)";

  const loginWrapper = document.getElementById("loginCtaWrapper");
  const paywall = document.getElementById("paywall");

  loginWrapper.style.display = "none";
  paywall.style.display = "none";

  if (!gerou) return;

  // 1¬™ prioridade: n√£o logado ‚Üí for√ßa login
  if (!logged) {
    loginWrapper.style.display = "block";
    paywall.style.display = "none"; // garante que paywall n√£o apare√ßa
    return;
  }

  // 2¬™ prioridade: logado e sem cr√©ditos ‚Üí paywall
  if (creditos <= 0) {
    paywall.style.display = "block";
  }
  // Caso contr√°rio: logado + cr√©ditos > 0 ‚Üí full access, nada aparece
}

document.getElementById("gerar").onclick = async () => {
  const produto = document.getElementById("produto").value.trim();
  if (!produto) return alert("Digite o produto ou servi√ßo");

  gerou = true;
  document.getElementById("resultado").style.display = "block";

  // Reset visual
  document.getElementById("diagnostico").innerText = "Analisando onde a maioria perde dinheiro‚Ä¶";
  document.getElementById("impacto").innerText = "";
  ['publico', 'angulo', 'imagem', 'copy', 'ctas'].forEach(id => {
    document.getElementById(id).innerText = "";
    document.getElementById(id).classList.add('blur');
  });

  try {
    if (auth.currentUser) {
      token = await auth.currentUser.getIdToken();
    }

    const res = await fetch(`${API}/api/anuncio`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(token && { Authorization: `Bearer ${token}` })
      },
      body: JSON.stringify({ produto })
    });

    if (!res.ok) {
      const errText = await res.text();
      throw new Error(errText || "Erro no servidor");
    }

    const data = await res.json();

    document.getElementById("diagnostico").innerText =
      `Seu risco agora √©: ${data.resultado.risco}\n\n${data.resultado.causa}`;

    document.getElementById("impacto").innerText = data.resultado.consequencia;

    document.getElementById("publico").innerText = data.resultado.publico || "Dispon√≠vel ap√≥s login e cr√©ditos";
    document.getElementById("angulo").innerText = data.resultado.angulo || "Dispon√≠vel ap√≥s login e cr√©ditos";
    document.getElementById("imagem").innerText = data.resultado.imagem || "Dispon√≠vel ap√≥s login e cr√©ditos";
    document.getElementById("copy").innerText = data.resultado.copy_base || "Vers√£o b√°sica focada em clareza.";
    document.getElementById("ctas").innerText = data.resultado.ctas ? data.resultado.ctas.join('\n\n') : "Varia√ß√µes dispon√≠veis ap√≥s login e cr√©ditos";

    if (data.acessoCompleto) {
      ['publico', 'angulo', 'imagem', 'copy', 'ctas'].forEach(id => {
        document.getElementById(id).classList.remove('blur');
      });
    }

    creditos = data.creditosRestantes ?? creditos;
    updateUI();

  } catch (e) {
    alert("Erro ao analisar: " + e.message);
    console.error(e);
  }
};

document.getElementById("loginCta").onclick = async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
    // onAuthStateChanged cuida do resto
  } catch (err) {
    alert("Erro no login: " + err.message);
  }
};

document.getElementById("comprar").onclick = async () => {
  if (!token) return alert("Fa√ßa login primeiro");
  try {
    const res = await fetch(`${API}/api/pagamento`, {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    if (data.checkout_url) {
      window.location.href = data.checkout_url;
    } else {
      alert("Erro ao iniciar pagamento");
    }
  } catch (e) {
    alert("Erro no pagamento: " + e.message);
  }
};
</script>
</body>
</html>
