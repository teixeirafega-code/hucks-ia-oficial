<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hucks IA ‚Äî Diagn√≥stico de An√∫ncios</title>

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --primary:#6366f1;
  --accent:#a855f7;
  --danger:#f97316;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#020617,#000);
  font-family:Inter,system-ui,sans-serif;
  color:#e5e7eb;
  display:flex;
  align-items:center;
  justify-content:center;
}
.container{
  width:100%;
  max-width:520px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:22px;
  padding:28px;
}
h1{text-align:center;margin:0 0 8px;font-size:2rem}
.sub{text-align:center;font-size:13px;color:#94a3b8;margin-bottom:24px}
input,button{
  width:100%;
  padding:16px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#fff;
  font-size:15px;
}
button{
  margin-top:14px;
  border:none;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(135deg,var(--primary),var(--accent));
}
.section{margin-top:26px;display:none}
.label{
  font-size:12px;
  text-transform:uppercase;
  font-weight:800;
  margin-bottom:8px;
}
.box{
  background:#020617;
  border:1px solid #1e293b;
  border-left:5px solid var(--primary);
  border-radius:14px;
  padding:16px;
  margin-bottom:18px;
  white-space:pre-wrap;
}
.risk{border-left-color:var(--danger)}
.blur{filter:blur(5px);opacity:.6}
.paywall{
  margin-top:18px;
  background:linear-gradient(135deg,#4f46e5,#7c3aed);
  padding:18px;
  border-radius:14px;
  text-align:center;
  display:none;
}
.paywall button{background:#fff;color:#000}
.footer{text-align:right;font-size:11px;color:#94a3b8}
</style>
</head>

<body>
<div class="container">
  <h1>tilapina IA</h1>
  <div class="sub">Descubra onde voc√™ est√° prestes a perder dinheiro em an√∫ncios.</div>

  <input id="produto" placeholder="Ex: Bolo de Pote, Curso de Ingl√™s"/>
  <button id="gerar">‚ú® Gerar Diagn√≥stico Seguro</button>

  <div id="resultado" class="section">
    <div class="label">‚ö†Ô∏è Diagn√≥stico de Risco</div>
    <div id="diagnostico" class="box risk"></div>

    <div class="label">üí∏ Impacto Real</div>
    <div id="impacto" class="box"></div>

    <div class="label">‚úçÔ∏è Copy Base</div>
    <div id="copy" class="box blur"></div>

    <div class="paywall" id="paywall">
      <p>üîí Desbloqueie a copy completa antes de anunciar errado.</p>
      <button id="comprar">Comprar Cr√©ditos</button>
    </div>

    <div class="footer">
      Saldo: <b><span id="creditos">0</span></b> cr√©ditos
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const API = location.hostname.includes("localhost")
  ? "http://localhost:3001"
  : "https://therux-backend.onrender.com";

let auth;
let token = null;

async function startApp() {
  const res = await fetch(`${API}/api/config`);
  const config = await res.json();
  const app = initializeApp(config);
  auth = getAuth(app);
}
startApp();

document.getElementById("gerar").onclick = async () => {
  const produto = document.getElementById("produto").value;
  if (!produto) return alert("Digite o produto");

  document.getElementById("resultado").style.display = "block";
  document.getElementById("diagnostico").innerText = "Analisando risco...";
  document.getElementById("impacto").innerText = "";
  document.getElementById("copy").innerText = "";

  // Pega o token do usu√°rio se estiver logado
  const user = auth.currentUser;
  if (user) token = await user.getIdToken();

  // üîë Chamada ao backend para gerar o diagn√≥stico
  const res = await fetch(`${API}/api/anuncio`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(token && { Authorization: `Bearer ${token}` })
    },
    body: JSON.stringify({ produto })
  });

  const data = await res.json();
  console.log("RESPOSTA API:", data);

  // Atualiza o DOM com os dados corretos
  document.getElementById("diagnostico").innerText =
`Risco: ${data.resultado.risco}

Por que isso √© um problema:
${data.resultado.causa}`;

  document.getElementById("impacto").innerText =
`Impacto real:
${data.resultado.consequencia}`;

  if (data.resultado.copy_base) {
    document.getElementById("copy").innerText = data.resultado.copy_base;
    document.getElementById("copy").classList.remove("blur");
    document.getElementById("paywall").style.display = "none";
  } else {
    document.getElementById("copy").innerText =
      "Essa √© apenas uma amostra. A vers√£o completa mostra exatamente o que mudar antes de anunciar.";
    document.getElementById("copy").classList.add("blur");
    document.getElementById("paywall").style.display = "block";
  }

  document.getElementById("creditos").innerText =
    data.creditosRestantes ?? "0";
};

document.getElementById("comprar").onclick = async () => {
  if (!auth.currentUser) return alert("Fa√ßa login para continuar");

  const token = await auth.currentUser.getIdToken();
  const res = await fetch(`${API}/api/pagamento`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` }
  });

  const data = await res.json();
  if (data.checkout_url) location.href = data.checkout_url;
};
</script>
</body>
</html>
